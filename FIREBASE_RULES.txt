rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Helper function to get user role from users collection
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }
    
    // Users collection
    match /users/{userId} {
      // Anyone can read user profiles
      allow read: if isSignedIn();
      
      // Users can only create their own profile during registration
      allow create: if isSignedIn() && request.auth.uid == userId;
      
      // Users can only update their own profile
      allow update: if isSignedIn() && request.auth.uid == userId;
      
      // No one can delete user profiles
      allow delete: if false;
    }
    
    // Classes collection
    match /classes/{classId} {
      // Anyone authenticated can read classes
      allow read: if isSignedIn();
      
      // Only teachers can create classes
      allow create: if isSignedIn() && 
                      getUserRole() == 'teacher' &&
                      request.resource.data.teacherId == request.auth.uid;
      
      // Only the class teacher can update their classes
      allow update: if isSignedIn() && 
                      resource.data.teacherId == request.auth.uid;
      
      // Only the class teacher can delete their classes
      allow delete: if isSignedIn() && 
                      resource.data.teacherId == request.auth.uid;
    }
    
    // Enrollments collection
    match /enrollments/{enrollmentId} {
      // Anyone authenticated can read enrollments
      allow read: if isSignedIn();
      
      // Only students can enroll themselves
      allow create: if isSignedIn() && 
                      getUserRole() == 'student' &&
                      request.resource.data.studentId == request.auth.uid;
      
      // No one can update enrollments
      allow update: if false;
      
      // Students can unenroll themselves (for future feature)
      allow delete: if isSignedIn() && 
                      resource.data.studentId == request.auth.uid;
    }
    
    // Attendance collection
    match /attendance/{attendanceId} {
      // Anyone authenticated can read attendance
      allow read: if isSignedIn();
      
      // Teachers can mark attendance for their classes
      // Students can mark their own attendance
      allow create: if isSignedIn() && (
        (getUserRole() == 'teacher' && 
         get(/databases/$(database)/documents/classes/$(request.resource.data.classId)).data.teacherId == request.auth.uid) ||
        (getUserRole() == 'student' && 
         request.resource.data.studentId == request.auth.uid)
      );
      
      // Only teachers can update attendance for their classes
      allow update: if isSignedIn() && 
                      getUserRole() == 'teacher' &&
                      get(/databases/$(database)/documents/classes/$(resource.data.classId)).data.teacherId == request.auth.uid;
      
      // No one can delete attendance records
      allow delete: if false;
    }
  }
}

